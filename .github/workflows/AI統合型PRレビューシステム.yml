name: ğŸ§  AIçµ±åˆå‹PRãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚·ã‚¹ãƒ†ãƒ 
on:
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]

jobs:
  intelligent-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å…¨å±¥æ­´ã‚’å–å¾—

      # 2. UVï¼ˆPythonãƒ„ãƒ¼ãƒ«ï¼‰ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: ğŸ”§ Setup UV
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      # 3. Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆClaude-Flowç”¨ï¼‰
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 4. çµ±åˆClaude Actionå®Ÿè¡Œ
      - name: ğŸ¤– Execute AI-Powered Review
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          # MCPã‚µãƒ¼ãƒãƒ¼è¨­å®š
          mcp_config: |
            {
              "mcpServers": {
                "serena": {
                  "command": "uvx",
                  "args": [
                    "--from", "git+https://github.com/oraios/serena",
                    "serena-mcp-server",
                    "--context", "ide-assistant",
                    "--project", "${{ github.workspace }}"
                  ]
                },
                "claude-flow": {
                  "command": "npx",
                  "args": [
                    "claude-flow@alpha", "mcp-server",
                    "--project", "${{ github.workspace }}"
                  ]
                }
              }
            }

          # åˆ©ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«
          allowed_tools: |
            # Serenaãƒ„ãƒ¼ãƒ«ï¼ˆç²¾å¯†ãªã‚³ãƒ¼ãƒ‰åˆ†æï¼‰
            mcp__serena__find_symbol
            mcp__serena__find_referencing_symbols
            mcp__serena__get_symbols_overview
            mcp__serena__replace_symbol_body
            mcp__serena__execute_shell_command

            # Claude-Flowãƒ„ãƒ¼ãƒ«ï¼ˆé«˜åº¦ãªèª¿æ•´ï¼‰
            mcp__claude-flow__swarm
            mcp__claude-flow__memory_store
            mcp__claude-flow__memory_query
            mcp__claude-flow__neural_train

            # åŸºæœ¬ãƒ„ãƒ¼ãƒ«
            Edit
            Replace
            Bash(npm test)
            Bash(npm run lint)

          # ã‚«ã‚¹ã‚¿ãƒ æŒ‡ç¤º
          custom_instructions: |
            ## ğŸ¯ ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ—ãƒ­ã‚»ã‚¹

            1. **Serenaã§ç²¾å¯†åˆ†æ**
               - get_symbols_overviewã§å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹é€ æŠŠæ¡
               - find_referencing_symbolsã§å½±éŸ¿ç¯„å›²ã‚’ç‰¹å®š
               
            2. **Claude-Flowã§æ·±å±¤åˆ†æ**
               - swarmã§è¤‡æ•°è¦³ç‚¹ã‹ã‚‰ä¸¦åˆ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
               - memory_queryã§éå»ã®é¡ä¼¼å•é¡Œã‚’å‚ç…§
               
            3. **çµ±åˆè©•ä¾¡**
               - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã®æ¤œå‡º
               - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å½±éŸ¿ã®è©•ä¾¡
               - ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ã®éµå®ˆç¢ºèª
               
            4. **è‡ªå‹•ä¿®æ­£ææ¡ˆ**
               - è»½å¾®ãªå•é¡Œã¯è‡ªå‹•ä¿®æ­£PRã‚’ä½œæˆ
               - é‡å¤§ãªå•é¡Œã¯è©³ç´°ãªæ”¹å–„æ¡ˆã‚’æç¤º
