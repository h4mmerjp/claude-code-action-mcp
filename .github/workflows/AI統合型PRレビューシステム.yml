name: 🧠 AI統合型PRレビューシステム
on:
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]

jobs:
  intelligent-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      # 1. リポジトリのチェックアウト
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 全履歴を取得

      # 2. UV（Pythonツール）のセットアップ
      - name: 🔧 Setup UV
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      # 3. Node.jsのセットアップ（Claude-Flow用）
      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 4. 統合Claude Action実行
      - name: 🤖 Execute AI-Powered Review
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          # MCPサーバー設定
          mcp_config: |
            {
              "mcpServers": {
                "serena": {
                  "command": "uvx",
                  "args": [
                    "--from", "git+https://github.com/oraios/serena",
                    "serena-mcp-server",
                    "--context", "ide-assistant",
                    "--project", "${{ github.workspace }}"
                  ]
                },
                "claude-flow": {
                  "command": "npx",
                  "args": [
                    "claude-flow@alpha", "mcp-server",
                    "--project", "${{ github.workspace }}"
                  ]
                }
              }
            }

          # 利用可能なツール
          allowed_tools: |
            # Serenaツール（精密なコード分析）
            mcp__serena__find_symbol
            mcp__serena__find_referencing_symbols
            mcp__serena__get_symbols_overview
            mcp__serena__replace_symbol_body
            mcp__serena__execute_shell_command

            # Claude-Flowツール（高度な調整）
            mcp__claude-flow__swarm
            mcp__claude-flow__memory_store
            mcp__claude-flow__memory_query
            mcp__claude-flow__neural_train

            # 基本ツール
            Edit
            Replace
            Bash(npm test)
            Bash(npm run lint)

          # カスタム指示
          custom_instructions: |
            ## 🎯 レビュープロセス

            1. **Serenaで精密分析**
               - get_symbols_overviewで変更ファイルの構造把握
               - find_referencing_symbolsで影響範囲を特定
               
            2. **Claude-Flowで深層分析**
               - swarmで複数観点から並列レビュー
               - memory_queryで過去の類似問題を参照
               
            3. **統合評価**
               - セキュリティリスクの検出
               - パフォーマンス影響の評価
               - コーディング規約の遵守確認
               
            4. **自動修正提案**
               - 軽微な問題は自動修正PRを作成
               - 重大な問題は詳細な改善案を提示
