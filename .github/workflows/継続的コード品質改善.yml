name: ğŸ“Š ç¶™ç¶šçš„ã‚³ãƒ¼ãƒ‰å“è³ªæ”¹å–„
on:
  schedule:
    - cron: "0 2 * * 1" # æ¯é€±æœˆæ›œæ—¥ã®æ·±å¤œ2æ™‚
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  code-quality-improvement:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Full Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ¯ Quality Analysis & Improvement
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          max_turns: "10"
          timeout_minutes: "60"
          branch_prefix: "quality/"

          mcp_config: |
            {
              "mcpServers": {
                "serena": {
                  "command": "uvx",
                  "args": [
                    "--from", "git+https://github.com/oraios/serena",
                    "serena-mcp-server",
                    "--mode", "planning",
                    "--mode", "editing"
                  ]
                },
                "claude-flow": {
                  "command": "npx",
                  "args": [
                    "claude-flow@alpha", "mcp-server",
                    "--neural-enhanced"
                  ]
                }
              }
            }

          direct_prompt: |
            ## ğŸ“Š é€±æ¬¡ã‚³ãƒ¼ãƒ‰å“è³ªæ”¹å–„ã‚¿ã‚¹ã‚¯

            ### Phase 1: åˆ†æï¼ˆClaude-Flowä¸»å°ï¼‰
            1. hive-mind spawnã§å…¨ä½“åˆ†æã‚’é–‹å§‹
            2. ä»¥ä¸‹ã®è¦³ç‚¹ã§å•é¡Œã‚’æ¤œå‡ºï¼š
               - é‡è¤‡ã‚³ãƒ¼ãƒ‰
               - è¤‡é›‘åº¦ã®é«˜ã„é–¢æ•°
               - æœªä½¿ç”¨ã®ã‚³ãƒ¼ãƒ‰
               - å‹ã®ä¸æ•´åˆ
               - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯

            ### Phase 2: å„ªå…ˆé †ä½ä»˜ã‘ï¼ˆSerenaæ”¯æ´ï¼‰
            1. find_referencing_symbolsã§é‡è¦åº¦ã‚’è©•ä¾¡
            2. æ”¹å–„ã«ã‚ˆã‚‹å½±éŸ¿åº¦ã‚’ç®—å‡º
            3. ãƒªã‚¹ã‚¯ã¨åŠ¹æœã®ãƒãƒ©ãƒ³ã‚¹ã‚’è€ƒæ…®

            ### Phase 3: æ”¹å–„å®Ÿè£…
            1. å„ªå…ˆåº¦ã®é«˜ã„å•é¡Œã‹ã‚‰é †ã«ä¿®æ­£
            2. å„ä¿®æ­£å¾Œã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
            3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¸ã®å½±éŸ¿ã‚’æ¸¬å®š

            ### Phase 4: ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
            1. æ”¹å–„å†…å®¹ã®ã‚µãƒãƒªãƒ¼ä½œæˆ
            2. ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®å¤‰åŒ–ã‚’è¨˜éŒ²
            3. æ¬¡å›ã¸ã®æ¨å¥¨äº‹é …ã‚’memory_storeã«ä¿å­˜

            æœ€å¤§5ã¤ã®æ”¹å–„ã‚’å®Ÿæ–½ã—ã€PRã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

          claude_env: |
            NODE_ENV: test
            CI: true
            QUALITY_CHECK: true
